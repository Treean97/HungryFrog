# .github/workflows/unity-android-build.yml
name: Android AAB Build

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  UNITY_VERSION: 6000.0.47f1
  UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
  UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
  KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
  KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
  KEY_ALIAS:      ${{ secrets.KEY_ALIAS }}
  KEY_PASSWORD:   ${{ secrets.KEY_PASSWORD }}

jobs:
  build-android:
    name: üê∏ Build Android AAB
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Decode Android keystore
        shell: pwsh
        run: |
          [IO.File]::WriteAllBytes(
            'user.keystore',
            [Convert]::FromBase64String($Env:KEYSTORE_BASE64)
          )

      - name: Activate Unity License
        shell: pwsh
        run: |
          $unity = "C:\Program Files\Unity\Hub\Editor\$Env:UNITY_VERSION\Editor\Unity.exe"
          & $unity -batchmode -nographics `
              -projectPath ${{ github.workspace }} `
              -username   $Env:UNITY_EMAIL `
              -password   $Env:UNITY_PASSWORD `
              -quit

      - name: Build Android AAB
        shell: pwsh
        run: |
          $unity = "C:\Program Files\Unity\Hub\Editor\$Env:UNITY_VERSION\Editor\Unity.exe"
          & $unity -batchmode -nographics `
              -projectPath ${{ github.workspace }} `
              -executeMethod BuildScript.BuildAndroid `
              -buildTarget Android `
              -quit `
              -logFile build.log

      - name: Return Unity License
        shell: pwsh
        run: |
          $unity = "C:\Program Files\Unity\Hub\Editor\$Env:UNITY_VERSION\Editor\Unity.exe"
          & $unity -batchmode -nographics `
              -projectPath ${{ github.workspace }} `
              -returnlicense `
              -quit

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-Android-aab
          path: build/app.aab
