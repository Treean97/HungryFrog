name: Build Android AAB (Host Unity)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: [self-hosted, Windows, X64]

    defaults:
      run:
        shell: powershell

    env:
      UNITY_EMAIL:             ${{ secrets.UNITY_EMAIL }}
      UNITY_PASSWORD:          ${{ secrets.UNITY_PASSWORD }}
      UNITY_SERIAL:            ${{ secrets.UNITY_SERIAL }}
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      ANDROID_KEYSTORE_PASS:   ${{ secrets.ANDROID_KEYSTORE_PASS }}
      ANDROID_KEYALIAS_NAME:   ${{ secrets.ANDROID_KEYALIAS_NAME }}
      ANDROID_KEYALIAS_PASS:   ${{ secrets.ANDROID_KEYALIAS_PASS }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache PackageCache
        uses: actions/cache@v4
        with:
          path: Library/PackageCache
          key: pkg-${{ runner.os }}-${{ hashFiles('Packages/packages-lock.json') }}

      - name: Clean Temp & build folders
        run: |
          if (Test-Path Temp)  { Remove-Item -Recurse -Force Temp }
          if (Test-Path build) { Remove-Item -Recurse -Force build }

      - name: Decode Android Keystore
        run: |
          $ks = [Convert]::FromBase64String($Env:ANDROID_KEYSTORE_BASE64)
          [IO.File]::WriteAllBytes('user.keystore', $ks)

      - name: Activate Unity License
        run: |
          $unityPath = 'C:\Program Files\Unity\Hub\Editor\6000.0.47f1\Editor\Unity.exe'
          & $unityPath `
            -batchmode -nographics `
            -username $Env:UNITY_EMAIL `
            -password $Env:UNITY_PASSWORD `
            -serial $Env:UNITY_SERIAL `
            -quit

      - name: Build Android AAB with Unity on Host
        run: |
          $unityPath = 'C:\Program Files\Unity\Hub\Editor\6000.0.47f1\Editor\Unity.exe'
          & $unityPath `
            -batchmode -nographics `
            -projectPath "${{ github.workspace }}" `
            -executeMethod BuildScript.BuildAndroid `
            -logFile "${{ github.workspace }}\build.log" `
            -quit

      - name: Return Unity License
        run: |
          $unityPath = 'C:\Program Files\Unity\Hub\Editor\6000.0.47f1\Editor\Unity.exe'
          & $unityPath -batchmode -returnlicense -quit

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-Android-aab
          path: build/app.aab
