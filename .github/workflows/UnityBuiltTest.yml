name: Build Android AAB (Host Unity)

on: workflow_dispatch

jobs:
  build:
    runs-on: [self-hosted, Windows, X64]
    defaults:
      run:
        shell: powershell

    env:
      KEYSTORE_BASE64:   ${{ secrets.KEYSTORE_BASE64 }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS:         ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD:      ${{ secrets.KEY_PASSWORD }}

    steps:
      - uses: actions/checkout@v4

      - name: Decode Android Keystore
        run: |
          [IO.File]::WriteAllBytes(
            'user.keystore',
            [Convert]::FromBase64String($Env:KEYSTORE_BASE64)
          )

      - name: Activate Unity License
        run: |
          $unityPath = 'C:\Program Files\Unity\Hub\Editor\6000.0.47f1\Editor\Unity.exe'
          & $unityPath -batchmode -nographics `
            -username $Env:UNITY_EMAIL `
            -password $Env:UNITY_PASSWORD `
            -quit

      - name: Build Android AAB
        run: |
          $unityPath = 'C:\Program Files\Unity\Hub\Editor\6000.0.47f1\Editor\Unity.exe'
          & $unityPath -batchmode -nographics `
            -projectPath "${{ github.workspace }}" `
            -executeMethod BuildScript.BuildAndroid `
            -buildTarget Android `
            -logFile "${{ github.workspace }}\build.log" `
            -quit

      - name: Show Unity Log
        if: always()
        run: |
          type build.log

      - name: Return Unity License
        run: |
          & 'C:\Program Files\Unity\Hub\Editor\6000.0.47f1\Editor\Unity.exe' `
            -batchmode -returnlicense -quit

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-Android-aab
          path: build/app.aab
